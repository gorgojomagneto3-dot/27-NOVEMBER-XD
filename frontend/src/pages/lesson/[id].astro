---
import Layout from '../../layouts/Layout.astro';

// Define all possible lesson IDs for static generation
export function getStaticPaths() {
  const lessonIds = [
    'b1', 'b2', 'b3', 'b4', 'b5', 'b6', 'b7', 'b8', 'b9', 'b10', 'b11', 'b12',
    'int1', 'int2', 'int3', 'int4', 'int5', 'int6', 'int7', 'int8', 'int9', 'int10', 'int11', 'int12',
    'exam-prep', 'common-mistakes', 'phrasal-verbs', 'advanced-grammar'
  ];
  
  return lessonIds.map(id => ({
    params: { id }
  }));
}

const { id } = Astro.params;
---

<Layout title="Lesson - English Learning App">
  <main class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Header -->
    <header class="sticky top-0 z-50 backdrop-blur-lg bg-slate-900/80 border-b border-white/10">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <a href="/" class="flex items-center gap-2 text-white hover:text-green-400 transition">
            <span class="text-2xl">‚Üê</span>
            <span>Back to Lessons</span>
          </a>
          <div class="flex items-center gap-3">
            <!-- Voice info -->
            <span id="voice-info" class="text-xs text-white/50 hidden sm:block"></span>
            
            <!-- Speed selector -->
            <select id="speed-select" class="px-2 py-1 rounded-lg bg-white/10 text-white text-sm border border-white/20 cursor-pointer">
              <option value="0.7">üê¢ Slow</option>
              <option value="0.85" selected>üéØ Normal</option>
              <option value="1.0">üêá Fast</option>
            </select>
            
            <!-- Audio toggle -->
            <button id="tts-toggle" class="px-4 py-2 rounded-lg bg-green-500/20 border border-green-500/50 hover:bg-green-500/30 text-green-400 transition flex items-center gap-2">
              <span class="text-lg">üîä</span>
              <span class="hidden sm:inline">Audio On</span>
            </button>
            
            <!-- Complete button -->
            <button id="complete-btn" class="px-6 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition">
              ‚úì Complete
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Lesson Content -->
    <div class="container mx-auto px-4 py-8">
      <div id="lesson-loading" class="text-center py-20">
        <div class="inline-block animate-spin text-4xl mb-4">‚è≥</div>
        <p class="text-white/60">Loading lesson...</p>
      </div>
      
      <article id="lesson-content" class="lesson-content max-w-4xl mx-auto hidden">
        <!-- Content will be loaded here -->
      </article>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-8 right-8 flex flex-col gap-3">
      <button id="scroll-top" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white text-xl transition opacity-0">
        ‚Üë
      </button>
    </div>
  </main>
</Layout>

<script define:vars={{ lessonId: id }}>
  // Use relative URL for production (Vercel), localhost for development
  const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000' : 'https://27-november-xd.vercel.app';
  let ttsEnabled = true;
  let googleVoice = null;
  let voicesLoaded = false;
  let speechRate = 0.85; // Default speed
  
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem('userId', userId);
    }
    return userId;
  }

  // Initialize Google TTS voices
  function initGoogleVoices() {
    const voices = window.speechSynthesis.getVoices();
    
    // Priority order for best English voices (Google voices are best)
    const preferredVoices = [
      'Google US English',
      'Google UK English Female', 
      'Google UK English Male',
      'Microsoft Zira',
      'Microsoft David',
      'Samantha', // macOS
      'Alex', // macOS
    ];
    
    // Find the best available voice
    for (const preferred of preferredVoices) {
      const found = voices.find(v => v.name.includes(preferred));
      if (found) {
        googleVoice = found;
        console.log('üîä Using voice:', googleVoice.name);
        break;
      }
    }
    
    // Fallback to any English voice
    if (!googleVoice) {
      googleVoice = voices.find(v => v.lang.startsWith('en-US')) || 
                   voices.find(v => v.lang.startsWith('en'));
      if (googleVoice) console.log('üîä Fallback voice:', googleVoice.name);
    }
    
    voicesLoaded = true;
  }

  // Load voices (Chrome loads them async)
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = initGoogleVoices;
    initGoogleVoices(); // Try immediately for Firefox/Safari
  }

  async function loadLesson() {
    try {
      const response = await fetch(`${API_URL}/api/lessons/${lessonId}`, {
        headers: {
          'X-User-ID': getUserId()
        }
      });
      const data = await response.json();
      
      if (data.success) {
        const contentEl = document.getElementById('lesson-content');
        const loadingEl = document.getElementById('lesson-loading');
        
        contentEl.innerHTML = data.lesson.content;
        contentEl.classList.remove('hidden');
        loadingEl.classList.add('hidden');
        
        // Add audio buttons to content
        addAudioButtons();
        // Add interactive exercises
        setupExercises();
      }
    } catch (error) {
      console.error('Error loading lesson:', error);
      document.getElementById('lesson-loading').innerHTML = `
        <div class="text-red-400 text-xl">‚ùå Error loading lesson</div>
        <p class="text-white/60 mt-2">Please check if the API server is running.</p>
        <a href="/" class="inline-block mt-4 px-6 py-2 bg-white/10 rounded-lg text-white hover:bg-white/20">
          ‚Üê Back to Home
        </a>
      `;
    }
  }

  function addAudioButtons() {
    // Add audio buttons to list items with arrows (translations)
    const listItems = document.querySelectorAll('.lesson-content li');
    listItems.forEach(li => {
      const text = li.textContent || '';
      if (text.includes('‚Üí') || text.includes('‚û°')) {
        const englishPart = text.split('‚Üí')[0]?.split('‚û°')[0]?.trim();
        if (englishPart && englishPart.length > 2) {
          const btn = document.createElement('button');
          btn.className = 'audio-btn ml-2 text-blue-400 hover:text-blue-300 hover:scale-110 transition-all';
          btn.innerHTML = 'üîä';
          btn.title = 'Click to hear pronunciation';
          btn.onclick = (e) => {
            e.stopPropagation();
            speak(englishPart, btn);
          };
          li.appendChild(btn);
        }
      }
    });

    // Add audio to headings (vocabulary sections, example sentences)
    const headings = document.querySelectorAll('.lesson-content h3, .lesson-content h4');
    headings.forEach(h => {
      const text = h.textContent?.replace(/[üî§üìùüí¨üéØüìö‚ú®üåüüí°‚ö°]/g, '').trim();
      if (text && text.length > 3 && /^[a-zA-Z\s]+$/.test(text)) {
        const btn = document.createElement('button');
        btn.className = 'audio-btn ml-3 text-green-400 hover:text-green-300 hover:scale-110 transition-all text-lg';
        btn.innerHTML = 'üîä';
        btn.title = 'Listen';
        btn.onclick = (e) => {
          e.stopPropagation();
          speak(text, btn);
        };
        h.appendChild(btn);
      }
    });

    // Add "Listen to all" button for vocabulary sections
    const vocabSections = document.querySelectorAll('.lesson-content ul');
    vocabSections.forEach(ul => {
      const items = ul.querySelectorAll('li');
      const englishWords = [];
      items.forEach(li => {
        const text = li.textContent || '';
        if (text.includes('‚Üí') || text.includes('‚û°')) {
          const eng = text.split('‚Üí')[0]?.split('‚û°')[0]?.trim();
          if (eng) englishWords.push(eng);
        }
      });
      
      if (englishWords.length > 2) {
        const listenAllBtn = document.createElement('button');
        listenAllBtn.className = 'listen-all-btn mb-3 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg text-white text-sm font-medium transition-all shadow-lg hover:shadow-xl';
        listenAllBtn.innerHTML = 'üéß Listen to all vocabulary';
        listenAllBtn.onclick = () => speakAll(englishWords);
        ul.parentElement?.insertBefore(listenAllBtn, ul);
      }
    });
  }

  function speak(text, btn = null) {
    if (!ttsEnabled || !window.speechSynthesis) return;
    
    // Cancel any ongoing speech
    window.speechSynthesis.cancel();
    
    // Clean text for better pronunciation
    const cleanText = text
      .replace(/[^\w\s'-]/g, '') // Remove special chars except apostrophe and hyphen
      .trim();
    
    if (!cleanText) return;
    
    const utterance = new SpeechSynthesisUtterance(cleanText);
    utterance.lang = 'en-US';
    utterance.rate = speechRate; // Use selected speed
    utterance.pitch = 1;
    utterance.volume = 1;
    
    // Use Google voice if available
    if (googleVoice) {
      utterance.voice = googleVoice;
    }
    
    // Visual feedback
    if (btn) {
      btn.innerHTML = 'üîâ';
      btn.classList.add('animate-pulse');
      utterance.onend = () => {
        btn.innerHTML = 'üîä';
        btn.classList.remove('animate-pulse');
      };
      utterance.onerror = () => {
        btn.innerHTML = 'üîä';
        btn.classList.remove('animate-pulse');
      };
    }
    
    window.speechSynthesis.speak(utterance);
  }

  // Speak multiple words with delay
  async function speakAll(words) {
    if (!ttsEnabled || !window.speechSynthesis) return;
    
    for (let i = 0; i < words.length; i++) {
      await new Promise(resolve => {
        const utterance = new SpeechSynthesisUtterance(words[i]);
        utterance.lang = 'en-US';
        utterance.rate = speechRate; // Use selected speed
        if (googleVoice) utterance.voice = googleVoice;
        utterance.onend = () => setTimeout(resolve, 500); // 500ms pause between words
        utterance.onerror = resolve;
        window.speechSynthesis.speak(utterance);
      });
    }
  }

  // Double-click on any text to hear it
  document.addEventListener('dblclick', (e) => {
    if (!ttsEnabled) return;
    const selection = window.getSelection()?.toString().trim();
    if (selection && selection.length > 1 && selection.length < 200) {
      speak(selection);
    }
  });

  function setupExercises() {
    // Find exercise lists (ordered lists with answers in parentheses)
    const exercises = document.querySelectorAll('.lesson-content ol li');
    exercises.forEach(li => {
      const text = li.innerHTML;
      const match = text.match(/\(([^)]+)\)\s*$/);
      
      if (match) {
        const answer = match[1];
        const question = text.replace(match[0], '').trim();
        
        // Check if there's a blank to fill
        if (question.includes('_____') || question.includes('______')) {
          li.innerHTML = `
            <span class="exercise-question">${question.replace(/_+/g, '<input type="text" class="exercise-input w-24 mx-1 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-center" data-answer="${answer}">')}</span>
            <button class="check-answer ml-2 px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded text-white text-sm transition">Check</button>
            <span class="answer-result ml-2 hidden"></span>
          `;
        }
      }
    });

    // Add event listeners to check buttons
    document.querySelectorAll('.check-answer').forEach(btn => {
      btn.addEventListener('click', function() {
        const li = this.closest('li');
        const input = li.querySelector('.exercise-input');
        const result = li.querySelector('.answer-result');
        const answer = input.dataset.answer.toLowerCase().trim();
        const userAnswer = input.value.toLowerCase().trim();
        
        if (userAnswer === answer) {
          result.textContent = '‚úÖ Correct!';
          result.className = 'answer-result ml-2 text-green-400';
          input.classList.add('border-green-400');
          recordExercise(true);
        } else {
          result.textContent = `‚ùå Answer: ${input.dataset.answer}`;
          result.className = 'answer-result ml-2 text-red-400';
          input.classList.add('border-red-400');
          recordExercise(false);
        }
        result.classList.remove('hidden');
      });
    });
  }

  async function recordExercise(correct) {
    try {
      await fetch(`${API_URL}/api/stats/exercise`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-User-ID': getUserId()
        },
        body: JSON.stringify({ correct })
      });
    } catch (error) {
      console.error('Error recording exercise:', error);
    }
  }

  async function completeLesson() {
    try {
      const response = await fetch(`${API_URL}/api/lessons/${lessonId}/complete`, {
        method: 'POST',
        headers: {
          'X-User-ID': getUserId()
        }
      });
      const data = await response.json();
      
      if (data.success) {
        window.showToast(`üéâ Lesson completed! +${data.xpEarned} XP`);
        document.getElementById('complete-btn').textContent = '‚úì Completed!';
        document.getElementById('complete-btn').classList.replace('bg-green-500', 'bg-gray-500');
      }
    } catch (error) {
      console.error('Error completing lesson:', error);
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    // Event Listeners
    document.getElementById('complete-btn')?.addEventListener('click', completeLesson);
    
    document.getElementById('tts-toggle')?.addEventListener('click', function() {
      ttsEnabled = !ttsEnabled;
      if (ttsEnabled) {
        this.innerHTML = '<span class="text-lg">üîä</span><span class="hidden sm:inline">Audio On</span>';
        this.classList.remove('bg-red-500/20', 'border-red-500/50', 'text-red-400');
        this.classList.add('bg-green-500/20', 'border-green-500/50', 'text-green-400');
      } else {
        this.innerHTML = '<span class="text-lg">üîá</span><span class="hidden sm:inline">Audio Off</span>';
        this.classList.remove('bg-green-500/20', 'border-green-500/50', 'text-green-400');
        this.classList.add('bg-red-500/20', 'border-red-500/50', 'text-red-400');
        window.speechSynthesis?.cancel();
      }
    });

    // Speed selector
    document.getElementById('speed-select')?.addEventListener('change', function() {
      speechRate = parseFloat(this.value);
    });

    // Show voice info when loaded
    const showVoiceInfo = () => {
      if (googleVoice) {
        const voiceInfo = document.getElementById('voice-info');
        if (voiceInfo) {
          voiceInfo.textContent = `üé§ ${googleVoice.name.replace('Google ', '').replace('Microsoft ', '')}`;
        }
      }
    };
    
    // Check voice periodically until loaded
    const voiceCheck = setInterval(() => {
      if (voicesLoaded) {
        showVoiceInfo();
        clearInterval(voiceCheck);
      }
    }, 100);

    // Scroll to top button
    const scrollBtn = document.getElementById('scroll-top');
    if (scrollBtn) {
      window.addEventListener('scroll', () => {
        scrollBtn.style.opacity = window.scrollY > 300 ? '1' : '0';
      });
      scrollBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // Load lesson
    loadLesson();
  });
</script>
